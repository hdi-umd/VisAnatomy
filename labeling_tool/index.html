<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title> </title>
    <link
      rel="stylesheet"
      href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="js/util.js"></script>
    <style>
      html {
        /* margin: 10px 10px 0px 10px; */
        padding: 0px;
        font-family: Arial;
      }
      body {
        font: normal 15px/20px Arial, serif;
        color: #333;
        margin: 0;
        padding: 0;
        background-color: #fff;
        min-height: 100%;
        height: 100%;
        overflow: hidden;
        overflow-y: auto;
      }
      div.upload {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: inline-block;
        height: 30px;
        padding: 3px 40px 3px 3px;
        position: relative;
        width: auto;
        min-width: 200px;
        margin-right: 20px;
      }
      div.upload:hover {
        opacity: 0.95;
      }
      div.upload input[type="file"] {
        display: input-block;
        width: 100%;
        height: 30px;
        opacity: 0;
        cursor: pointer;
        position: absolute;
        left: 0;
      }
      .uploadButton {
        background-color: #425F9C;
        border: none;
        border-radius: 3px;
        color: #fff;
        cursor: pointer;
        display: inline-block;
        height: 30px;
        margin-right: 15px;
        width: auto;
        padding: 0 20px;
        box-sizing: content-box;
      }
      .fileName {
        font-family: Arial;
        font-size: 14px;
      }
      .upload + .uploadButton {
        height: 38px;
      }
      #uploadData {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -60%);
      }
    </style>
  </head>
  <body>
    <div id="uploadData" style="padding: 0 30px 0 30px">
      <h2>Import and Annotate an SVG Chart</h2>
      <h3>
        Remark: if some style information is contained in the CSS file
        associated with the webpage in which the SVG is embedded in, try to add
        that information to the SVG file.
      </h3>
      <!-- solution from http://jsfiddle.net/umhva747/ -->
      <form action="labeling_tool/annotationPage.html" id="uploadForm">
        <div style="margin-bottom: 15px;">
          <label for="chartType" style="display: block; margin-bottom: 5px; font-weight: bold;">Chart Type:</label>
          <select id="chartType" name="chartType" style="padding: 8px; border: 1px solid white; border-radius: 3px; font-size: 14px; min-width: 200px;">
          </select>
        </div>
        <div class="upload">
          <input type="button" class="uploadButton" value="Browse" />
          <input type="file" name="upload" accept="image/*" id="myFile" />
          <span class="fileName">Select file..</span>
        </div>
        <input type="submit" class="uploadButton" value="Import" />
      </form>
    </div>
    <script>
      // Chart types array
      const chartTypes = {
        "": "Select chart type...",
        "AreaChart": "Area Chart",
        "BarChart": "Bar Chart",
        "BarChartInRadialLayout": "Bar Chart in Radial Layout",
        "BoxAndWhisker": "Box-and-whisker Plot",
        "BubbleChart": "Bubble Chart",
        "BulletChart": "Bullet Chart",
        "BumpChart": "Bump Chart",
        "Calendar": "Calendar",
        "CandlestickChart": "Candlestick Chart",
        "CirclePacking": "Circle Packing",
        "ConnectedDotPlot": "Connected Dot Plot",
        "ConnectedScatterPlot": "Connected Scatterplot",
        "DensityPlot": "Density Plot",
        "DivergingStackedBarChart": "Diverging Stacked Bar Chart",
        "DonutChart": "Donut Chart",
        "DotPlot": "Dot Plot",
        "GanttChart": "Gantt Chart",
        "GeoHeatmap": "Geo Heatmap",
        "GroupedBarChart": "Grouped Bar Chart",
        "Heatmap": "Heatmap",
        "KagiChart": "Kagi Chart",
        "LineGraph": "Line Graph",
        "MarimekkoChart": "Marimekko Chart",
        "MatrixDiagram": "Matrix Diagram",
        "ParallelCoordinatesPlot": "Parallel Coordinates Plot",
        "PieChart": "Pie Chart",
        "PolarAreaChart": "Polar Area Chart",
        "RadarChart": "Radar Chart",
        "RadialBarChart": "Radial Bar Chart",
        "RangeChart": "Range Chart",
        "Scatterplot": "Scatterplot",
        "SpiralPlot": "Spiral Plot",
        "StackedAreaChart": "Stacked Area Chart",
        "StackedBarChart": "Stacked Bar Chart",
        "StreamGraph": "Stream Graph",
        "Treemap": "Treemap",
        "ViolinPlot": "Violin Plot",
        "WaffleChart": "Waffle Chart",
        "WaterfallChart": "Waterfall Chart",
        "WordCloud": "Word Cloud"
      };
      // Populate dropdown on page load
      document.addEventListener('DOMContentLoaded', function() {
        const select = document.getElementById('chartType');
        for (const [value, label] of Object.entries(chartTypes)) {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = label;
          select.appendChild(option);
        }
      });
      async function getNextChartId(chartType) {
        try {
          // Get list of existing chart files from server
          const response = await fetch('http://localhost:5200/list_charts');
          const data = await response.json();
          let maxId = 0;
          // Parse filenames to find highest existing ID for this specific chart type
          data.files.forEach(filename => {
            const match = filename.match(/([A-Za-z]+)(\d+)\.svg$/);
            if (match && match[1] === chartType) {
              const id = parseInt(match[2]);
              if (id > maxId) {
                maxId = id;
              }
            }
          });
          const nextId = maxId + 1;
          return nextId;
        } catch (error) {
          console.error('Error getting chart list:', error);
          // Fallback to simple counter if server call fails
          return 1;
        }
      }
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();
          const fileInput = document.getElementById("myFile");
          const file = fileInput.files[0];
          const chartTypeSelect = document.getElementById("chartType");
          if (!file) {
            alert("Please select a file.");
            return;
          }
          if (!chartTypeSelect.value) {
            alert("Please select a chart type.");
            return;
          }
          const filename = file.name;
          const chartType = chartTypeSelect.value;
          const id = await getNextChartId(chartType);
          const newFileName = `${chartType}${id}.svg`;
          try {
            const response = await fetch(
              `http://localhost:5200/check_file_exists/${newFileName}`
            );
            const data = await response.json();

            const reader = new FileReader();
            reader.onload = async function (e) {
                const svgData = e.target.result;
                const uploadResponse = await fetch(`http://localhost:5200/upload_svg`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        filename: newFileName,
                        svgData: svgData
                    }),
                });
                if (uploadResponse.ok) {
                    const result = await uploadResponse.json();
                    console.log(`File saved as ${result.filename}`);
                } else {
                    console.error("Error saving file to charts_svg folder.");
                }
                // Call newSVG and submit form after upload completes
                newSVG(newFileName, chartType);
                event.target.submit();
            };
            reader.readAsText(file);
          } catch (error) {
            console.error("Error:", error);
          }
        });
      $("input[type=file]").change(function (e) {
        $in = $(this);
        $in.next().html($in.val());
      });
      function newSVG(newFileName, chartType) {
        let uploadedSVG = document.getElementById("myFile").files[0];
        let fileReader = new FileReader();
        fileReader.readAsText(uploadedSVG);
        fileReader.onload = function () {
          sessionStorage.setItem("svg", fileReader.result);
          sessionStorage.setItem("fileName", newFileName || uploadedSVG.name);
          sessionStorage.setItem("chartType", chartType || "");
        };
        document.getElementById("myFile").value = null;
      }
      $(document).ready(() => {
        sessionStorage.setItem("svg", "");
        sessionStorage.setItem("fileName", undefined);
      });
    </script>
  </body>
</html>
