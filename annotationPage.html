<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const handler = d3.drag();
    </script>
    <link rel="shortcut icon" href="#" />
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.min.css"
    />
    <link
      rel="stylesheet"
      href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css"
    />
    <link rel="stylesheet" href="./annotationPage.css" />
    <title> </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css"
    />
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"
    ></script>
    <script type="text/javascript" src="js/html2canvas.min.js"></script>
    <script type="text/javascript" src="js/cleanup.js"></script>
    <script type="text/javascript" src="js/display.js"></script>
    <script type="text/javascript" src="js/extract.js"></script>
    <script type="text/javascript" src="js/util.js"></script>
    <script type="text/javascript" src="js/preprocess-interaction.js"></script>
    <script type="text/javascript" src="js/grouping.js"></script>
    <script type="text/javascript" src="js/markAnnotation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <script type="text/javascript">
      // has to be placed here to be able to called the KeyPress function in process.js
      document.onkeydown = KeyPress;
    </script>
    <script src="js/atlas.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-GLhlTQ8iRABdZLl6O5oZ8gneFt8B0ZxyZxcfJlF+OwzIbh0C2pZsSq8p0yZ6Jizo"
      crossorigin="anonymous"
    ></script>
  </head>
  <body ondrop="drop(event)" ondragover="allowDrop(event)">
    <div class="notification" id="alertBox">
      "notification info when saving"
    </div>
    <div style="display: none">
      <ul id="demoList" class="demos"></ul>
      <svg
        id="layers"
        style="
          position: absolute;
          top: 0px;
          left: 0px;
          width: 240px;
          height: 300px;
          background: #f2f2f2;
          border-right: 1px solid #ccc;
        "
      ></svg>
    </div>
    <div id="breadcrumb"></div>
    <button
      id="nextButton"
      onclick="nextSection()"
      style="position: absolute; left: calc(50% + 275px); top: 8px"
    >
      Next
    </button>
    <button
      id="prevButton"
      onclick="prevSection()"
      style="position: absolute; right: calc(50% + 260px); top: 8px"
    >
      Back
    </button>
    <button
      id="saveButton"
      onclick="post()"
      style="position: absolute; top: 8px; right: calc(2%)"
    >
      Save
    </button>
    <div id="preprocessUI" style="visibility: visible">
      <div class="mainbox" id="axisAndLegend">
        <div style="margin-left: 20px">
          <span style="margin-right: 30px; font-weight: bold"
            >Axis & Legend Detection Results</span
          >
          <span
            ><img
              id="questionMark"
              src="img/question mark.png"
              alt="Question Mark"
              style="width: 15px; height: 15px; cursor: pointer"
          /></span>
          <div class="pop-out-container" id="popOutContainer">
            <span class="close-button" id="closeButton">&times;</span>
            <div class="pop-out-content">
              Axes allow you to associate data points with specific values. Axis
              ticks help indicate the value of a chart's point. Axis titles
              provide you with context about these values. Axis labels describe
              portions of the axis.<br /><br />
              Legends help you to understand marks used in a visualization.
              Titles describe what part of the visualization the legend is
              describing. Keys are items that correspond to marks in the chart.
              Key labels describe what each key represents.<br /><br />
              Please refer to this
              <a
                href="https://docs.google.com/presentation/d/16inrHVY68xlDkUvm1-vOiDvc73Lzdrz4k1TeXARsj_g/edit#slide=id.g284e6c3512f_0_24"
                target="_blank"
                >link</a
              >
              for more information.
            </div>
          </div>
        </div>
        <div class="float-container" id="buttons" style="display: block">
          <!-- This is the main x axis div -->
          <div class="axisDiv" id="xAxisDiv">
            <!--This is the first part of the column-->
            <div class="axisMeta" id="xAxisMeta">
              <b>X axis</b>
              <input
                type="image"
                src="img/select-area.png"
                id="xArea"
                onclick="activateAreaSelect('x');"
                width="16px"
                height="16px"
                class="selectAreaBtn"
              /><br />
              <select
                class="fieldType"
                id="xFieldType"
                onchange="fieldTypeChanged('x')"
              >
                <option value="Null">none</option>
                <option value="string">categories</option>
                <option value="number">numbers</option>
                <option value="date">dates</option>
              </select>
            </div>

            <!--This is the second part of the column (title)-->

            <div
              class="axisTitle"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              id="xTitle"
            >
              <!--<div id="title-container">
                            <input type="text" class="textbox" placeholder="TITLE">
                          </div>-->
            </div>

            <!--This is the third part of the column (the label)-->
            <div
              class="axisLabels"
              id="xLabels"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
            ></div>
            <input
              type="image"
              src="img/plus.png"
              id="addXAxis"
              onclick="addAxisLevel('x');"
              width="16px"
              height="16px"
              style="position: absolute; right: 7px"
              class="selectAreaBtn"
            />
          </div>

          <!-- This is the main y axis div -->
          <div class="axisDiv" id="yAxisDiv">
            <!-- This is the 1st column div -->

            <div class="axisMeta">
              <b>Y axis</b
              ><input
                type="image"
                src="img/select-area.png"
                id="yArea"
                onclick="activateAreaSelect('y');"
                width="16px"
                height="16px"
                class="selectAreaBtn"
              /><br />
              <select
                class="fieldType"
                id="yFieldType"
                onchange="fieldTypeChanged('y')"
              >
                <option value="Null">none</option>
                <option value="string">categories</option>
                <option value="number">numbers</option>
                <option value="date">dates</option>
              </select>
            </div>

            <!-- This is the 2nd column div -->

            <div
              class="axisTitle"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              id="yTitle"
            ></div>

            <!-- This is the 3rd column div -->
            <div
              class="axisLabels"
              id="yLabels"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
            ></div>

            <input
              type="image"
              src="img/plus.png"
              id="addYAxis"
              onclick="addAxisLevel('y');"
              width="16px"
              height="16px"
              style="position: absolute; right: 7px"
              class="selectAreaBtn"
            />
          </div>

          <!-- This is the  main legend div -->

          <div class="axisDiv">
            <!-- This is the 1st column div -->

            <div class="axisMeta">
              <b>Legend</b
              ><input
                type="image"
                src="img/select-area.png"
                id="legendArea"
                onclick="activateAreaSelect('legend');"
                width="16px"
                height="16px"
                class="selectAreaBtn"
              /><br />
              <select class="fieldType" id="legendFieldType">
                <option value="Null">none</option>
                <option value="string">categories</option>
                <option value="number">numbers</option>
                <option value="date">dates</option>
              </select>
            </div>

            <!-- This is the 2nd column div-->
            <div
              class="axisTitle"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              id="legendTitle"
            ></div>

            <!-- This is the 3rd column div-->
            <div
              class="axisLabels"
              id="legendLabels"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
            ></div>
          </div>
        </div>
      </div>
      <div id="container">
        <div
          id="rbox1"
          class="rbox1"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            display: block;
            border: #ccc 0px solid;
          "
        ></div>
        <div
          id="rbox2"
          class="rbox2"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            display: block;
            pointer-events: none;
            border: #ccc 0px solid;
          "
        >
          <svg
            id="overlay"
            height="100%"
            width="100%"
            preserveAspectRatio="xMinYMid"
          >
            <rect
              id="overlaySelection"
              style="
                visibility: hidden;
                stroke-width: 2px;
                stroke: blue;
                fill: none;
              "
            ></rect>
          </svg>
        </div>
        <div
          id="generalizedSelection"
          style="
            position: absolute;
            top: 20px;
            right: 10px;
            display: block;
            width: 40%;
            height: calc(100% - 50px);
            border: #ccc 0px solid;
          "
        >
          <div style="height: 100%">
            <h3>All Mark IDs</h3>

            <div
              id="allMarks"
              style="
                height: 90%;
                width: 250px;
                border: #0ba7bc 1px solid;
                padding: 5px;
                margin-bottom: 10px;
                vertical-align: top;
                overflow: scroll;
                overflow: -moz-scrollbars-vertical;
              "
            ></div>
          </div>
          <div
            style="
              height: 100%;
              width: calc(100% - 275px);
              position: absolute;
              top: 0;
              right: 0;
            "
          >
            <h3>Mark Selections</h3>
            <div
              id="markSelections"
              style="
                height: calc(90% - 150px);
                width: 100%;
                border: #0ba7bc 1px solid;
                padding: 5px;
                margin-bottom: 10px;
                vertical-align: top;
                overflow: scroll;
                overflow: -moz-scrollbars-vertical;
              "
            ></div>
          </div>
          <div
            style="
              height: 150;
              width: calc(100% - 275px);
              position: absolute;
              bottom: 0;
              right: 0;
            "
          >
            <h3>Mark Types and Roles</h3>
            <div
              id="markRoles"
              style="
                height: 100%;
                width: 100%;
                border: #0ba7bc 1px solid;
                padding: 5px;
                margin-bottom: 10px;
              "
            >
              <div width="100%">
                Select a Mark Type
                <select
                  class="fieldType"
                  id="markTypeSelection"
                  onchange="markAnnotationChanged('Type')"
                >
                  <option value="none">Not Assigned</option>
                  <option value="Singleline">Straight Line</option>
                  <option value="Polyline">Polyline</option>
                  <option value="Rectangle">Rectangle</option>
                  <option value="Circle">Circle</option>
                  <option value="Ellipse">Ellipse</option>
                  <option value="Ploygon">Ploygon</option>
                  <option value="Area">Area</option>
                  <option value="Image">Image</option>
                  <option value="Text">Text</option>
                </select>
              </div>
              <br />
              <div width="100%">
                Select a Mark Role
                <select
                  class="fieldType"
                  id="markRoleSelection"
                  onchange="markAnnotationChanged('Role')"
                >
                  <option value="none">Not Assigned</option>
                  <option value="Main Chart">Main Chart</option>
                  <option value="Grid Line">Gridlines</option>
                  <option value="Annotation">Annotation</option>
                  <option value="xAxisLine">X Axis Line</option>
                  <option value="xAxisTick">X Axis Tick</option>
                  <option value="yAxisLine">Y Axis Line</option>
                  <option value="yAxisTick">Y Axis Tick</option>
                  <option value="Noise">Noise</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const questionMark = document.getElementById("questionMark");
      const popOutContainer = document.getElementById("popOutContainer");
      const closeButton = document.getElementById("closeButton");

      questionMark.addEventListener("click", function () {
        //when ? is clicked
        popOutContainer.style.display = "block";
      });

      closeButton.addEventListener("click", function () {
        //when the cross mark is clicked
        popOutContainer.style.display = "none";
      });

      window.addEventListener("click", function (event) {
        //close window
        if (
          event.target !== questionMark &&
          event.target !== closeButton &&
          !popOutContainer.contains(event.target)
        ) {
          popOutContainer.style.display = "none";
        }
      });

      window.addEventListener("beforeunload", function (event) {
        event.returnValue = "Are you sure you want to leave?";
        return "Are you sure you want to leave?";
      });

      // Initialize the section title and breadcrumb navigation
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize breadcrumb navigation
        updateBreadcrumb();
      });

      var annotationLoaded = false;

      // breadcrumb ui functions
      const sectionTitles = [
        "Axis & Legend",
        "Marks",
        "Groups",
        "Layout",
        "Encodings",
        "Constraints",
      ];

      let currentSectionIndex = 0;

      function nextSection() {
        if (currentSectionIndex < sectionTitles.length - 1) {
          currentSectionIndex++;
        }
        updateBreadcrumb();
      }

      function prevSection() {
        if (currentSectionIndex > 0) {
          currentSectionIndex--;
        }
        updateBreadcrumb();
      }

      // Function to update the breadcrumb navigation
      function updateBreadcrumb() {
        const breadcrumbContainer = document.getElementById("breadcrumb");
        breadcrumbContainer.innerHTML = ""; // Clear previous breadcrumbs

        for (let i = 0; i < sectionTitles.length; i++) {
          const breadcrumbItem = document.createElement("span");
          breadcrumbItem.textContent = sectionTitles[i];
          breadcrumbItem.classList.add("breadcrumb-item");
          if (i === currentSectionIndex) {
            breadcrumbItem.classList.add("current-section");
          }
          breadcrumbContainer.appendChild(breadcrumbItem);

          if (i < sectionTitles.length - 1) {
            const separator = document.createElement("span");
            separator.textContent = " | ";
            breadcrumbContainer.appendChild(separator);
          }
        }
        arrangeAnnotationDivs(sectionTitles[currentSectionIndex]);
      }

      function arrangeAnnotationDivs(currentStage) {
        switch (currentStage) {
          case "Axis & Legend":
            referenceElements.forEach((rid) => {
              d3.select("#" + rid).style("opacity", "1");
            });
            allLeftNodes
              .map((node) => node.id)
              .forEach((r) => {
                d3.select("#" + r).style("opacity", "1");
              });
            document.getElementById("axisAndLegend").style.visibility =
              "visible";
            document.getElementById("generalizedSelection").style.visibility =
              "hidden";
            break;
          case "Marks":
            // remove all reference elements from mainContent
            mainContentElements = groupSVGElementsByType();
            console.log(mainContentElements);

            // below for initilizing the mark annotation
            initilizeMarkAnnotation();

            document.getElementById("axisAndLegend").style.visibility =
              "hidden";
            document.getElementById("generalizedSelection").style.visibility =
              "visible";
            break;
          case "Groups":
          case "Layout":
          case "Encodings":
          case "Constraints":
          default:
            document.getElementById("axisAndLegend").style.visibility =
              "hidden";
            document.getElementById("generalizedSelection").style.visibility =
              "hidden";
            break;
        }
      }

      var demoName, mainContent;
      var areaSelection;
      var numOfColor;
      const fileName = sessionStorage.getItem("fileName");

      window.onhashchange = refresh;

      function refresh() {
        console.log(fileName);
        if (fileName) {
          loadDemo(fileName);
        }
      }

      function loadDemo(demo) {
        loadFile();
        fetch("./examples/" + demo)
          .then((resp) => {
            return resp.text();
          })
          .then((rawSVG) => {
            if (
              sessionStorage.getItem("svg")
                ? sessionStorage.getItem("svg").length > 0
                : false
            )
              rawSVG = sessionStorage.getItem("svg");

            titleXaxis = [];
            inXTitle = false;
            titleYaxis = [];
            inYTitle = false;
            titleLegend = [];

            demoName = demo;
            d3.select("#preprocessUI").style("visibility", "visible");
            d3.select("#layers").selectAll("*").remove();

            // in display.js, adding id and class attributes to the svg elements
            displaySVG(rawSVG);

            // TBD: we need to update the flattenSVG function to be consistent with groupSVGElementsByType(), to avoid the previous complex lead-node processing
            let jsonArr = flattenSVG(rawSVG);
            // in preprocess-interaction.js, attaching drag and drop event listeners to the svg text elements
            enableDragDrop(jsonArr.texts);

            if (!annotationLoaded) {
              d3.selectAll(".axisLabels").selectAll("button").remove();
              // in extract.js, extracting from the svg file the legend mark and labels, and the x and y axis labels, ticks, and paths if any, and the grid lines if any
              // extract() calls displayAxis() and displayLegend() to display the extracted elements
              mainContent = extract(jsonArr);
            }

            // in display.js, setting a proper view box for the svg file so that the svg file fits into the browser window
            setViewBox();

            // in preprocess-interaction.js, activating the area-selecting event so that one can also select the area of the legend, or x and y axis to annotate
            enableAreaSelection();
          });
      }

      document.addEventListener("keyup", function (e) {
        if (e.code == "Escape") deactivateAreaSelect();
      });

      $(document).ready(() => {
        refresh();
      });
    </script>
  </body>
</html>
