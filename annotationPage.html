<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      const handler = d3.drag();
    </script>
    <link rel="shortcut icon" href="#" />
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/9.0.0/nouislider.min.css"
    />
    <link
      rel="stylesheet"
      href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css"
    />
    <title> </title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css"
    />
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"
    ></script>
    <script type="text/javascript" src="js/html2canvas.min.js"></script>
    <script type="text/javascript" src="js/cleanup.js"></script>
    <script type="text/javascript" src="js/display.js"></script>
    <script type="text/javascript" src="js/extract.js"></script>
    <script type="text/javascript" src="js/util.js"></script>
    <script type="text/javascript" src="js/preprocess-interaction.js"></script>
    <script type="text/javascript" src="js/grouping.js"></script>
    <script type="text/javascript" src="js/markAnnotation.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    <script type="text/javascript">
      // has to be placed here to be able to called the KeyPress function in process.js
      document.onkeydown = KeyPress;
    </script>
    <script src="js/atlas.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font: normal 15px/20px Arial, serif;
        color: #333;
        margin: 0;
        padding: 0;
        background-color: #fff;
        min-height: 100%;
        height: 100%;
        overflow: hidden;
        overflow-y: auto;
        /* background-image: -moz-linear-gradient(90deg, #e0e0e0, #fff);
            background-image: -webkit-gradient(linear, 0% 0%, 0% 100%, color-stop(0, #e0e0e0), color-stop(0.25, #fff));
            background-repeat: repeat-x; */
      }

      /* breadcrumb ui */
      #nextButton {
        /* position: absolute;
        bottom: 20px;
        right: 100px; */
        width: 100px;
        height: 30px;
        background: #eee;
        border: #ccc 1px solid;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        line-height: 10px;
        z-index: 999;
      }
      #prevButton {
        /* position: absolute;
        bottom: 20px;
        right: 100px; */
        width: 100px;
        height: 30px;
        background: #eee;
        border: #ccc 1px solid;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        line-height: 10px;
        z-index: 999;
      }
      #breadcrumb {
        position: absolute;
        left: calc(50% - 250px);
        width: 500px;
        height: 30px;
        font-weight: bold;
        margin: 10px 0;
        margin-left: 25px;
        margin-right: 25px;
      }
      .breadcrumb-item {
        margin-right: 3px;
        margin-left: 3px;
      }
      .current-section {
        font-weight: bold;
        background-color: #58a9ff;
        color: white;
        padding: 3px 3px;
        border-radius: 3px;
      }

      /* main container with all 3 columns */
      #buttons {
        display: grid;
      }

      .a1 {
        font-size: 30px;
        font-weight: 500;
        color: #4f0599;
        text-shadow: 0px 0px 5px #b393d3, 0px 0px 10px #b393d3,
          0px 0px 10px #b393d3, 0px 0px 20px #b393d3;
        margin: 0px 50px 0px 0px;
        text-decoration: none;
      }

      .a2 {
        font-size: 25px;
        font-weight: 500;
        color: #553c9a;
        margin: 0px 50px 0px 0px;
        text-decoration: none;
      }

      .a2:hover {
        color: #896fd1;
        cursor: pointer;
      }

      #demoList {
        width: 240px;
        border-right: 1px solid #ccc;
        border-top: 1px solid #ccc;
        background: #f2f2f2;
        margin: 0;
        padding: 20px 5px 20px 25px;
        position: absolute;
        top: 300px;
        left: 0;
        list-style: none;
        font-size: 14px;
        overflow-y: scroll;
        height: calc(100% - 300px);
      }
      .category {
        margin: 15px 0 10px -7px;
        font-weight: bold;
      }
      .demos {
        margin-bottom: 10px;
        padding: 0px 15px 0 5px;
        list-style: none;
      }
      .demos li:hover {
        cursor: pointer;
        color: blue;
      }

      .mainbox {
        width: calc(98% - 0px);
        margin-left: 10px;
        margin-bottom: 15px;
        padding-top: 10px;
        position: absolute;
        bottom: 0;
        left: 0px;
        height: 220px;
      }

      .pages {
        width: calc(98% - 0px);
        height: 45px;
        position: absolute;
        top: 0px;
        left: 0px;
        margin-left: 15px;
        margin-top: 45px;
        /* border: #ccc 1px solid; */
      }

      #container {
        width: calc(98% - 0px);
        height: calc(100% - 300px);
        position: absolute;
        top: 40px;
        left: 0px;
        margin-left: 10px;
        margin-top: 15px;
        border: #ccc 1px solid;
      }

      .rbox1 {
        width: 55%;
        height: calc(100% - 20px);
        margin: 0 20px 20px;
        /* padding: 20px; */
      }

      .rbox2 {
        width: 55%;
        height: calc(100% - 20px);
        margin: 0 20px 20px;
        /* padding: 20px; */
      }

      .float-container {
        padding: 10px;
        width: 100%;
        border: #ccc 0px solid;
      }

      .labelButton {
        display: inline-block;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        outline: none;
        color: black;
        opacity: 0.85;
        /* background-color: #D7EBCC; */
        background-color: #f2f2f2;
        border: none;
        border-radius: 5px;
        margin-left: 5px;
        padding-left: 5px;
        padding-right: 5px;
      }

      .labelButton:hover {
        opacity: 1;
        /* background-color: #3e8e41; */
        background-color: #333;
        color: #fff;
      }

      .labelButton:active {
        /* background-color: #3e8e41; */
        background-color: #333;
        color: #fff;
        transform: translateY(2px);
      }

      .titleXbutton,
      .titleYbutton,
      .legendTitleID {
        display: inline-block;
        cursor: pointer;
        text-align: center;
        text-decoration: none;
        outline: none;
        color: black;
        opacity: 0.85;
        /* background-color: #D7EBCC; */
        background-color: #f2f2f2;
        border: none;
        border-radius: 5px;
        margin-left: 5px;
        padding-left: 5px;
        padding-right: 5px;
      }

      .titleXbutton:hover {
        opacity: 1;
        /* background-color: #3e8e41; */
        background-color: #333;
        color: #fff;
      }

      .titleYbutton:hover {
        opacity: 1;
        /* background-color: #3e8e41; */
        background-color: #333;
        color: #fff;
      }

      .legendTitleID:hover {
        opacity: 1;
        /* background-color: #3e8e41; */
        background-color: #333;
        color: #fff;
      }

      .div4text {
        text-align: center;
        cursor: pointer;
        background-color: #d7ebcc;
      }

      .div4td {
        background: #c0c0c0;
        text-align: center;
      }

      div.tooltip {
        position: absolute;
        text-align: center;
        width: 200px;
        padding: 2px;
        font: 12px sans-serif;
        background: rgb(255, 255, 255);
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        min-height: 28px;
      }

      div.tooltip2 {
        position: absolute;
        text-align: center;
        width: 280px;
        padding: 2px;
        font: 14.5px sans-serif;
        background: rgb(255, 255, 255);
        border: 0px;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        min-height: 28px;
        align-items: center;
        justify-content: center;
      }

      td {
        cursor: grab;
        padding: 5px;
        border-bottom: #eee 1px solid;
        text-align: center;
      }

      td:hover {
        background-color: #eee;
      }

      /* #preprocessUI select option:disabled {
            display:none;
        } */

      .axisDiv {
        width: 100%;
        height: 65px;
        border: #ddd 0px solid;
      }
      .axisMeta {
        width: 110px;
        border: #ddd 0px solid;
        height: 45px;
        display: inline-block;
        vertical-align: top;
        text-align: right;
        margin-right: 10px;
      }
      .axisTitle {
        width: 250px;
        border: #bbb 1px solid;
        height: 45px;
        display: inline-block;
        vertical-align: top;
        overflow: scroll;
        overflow: -moz-scrollbars-vertical;
        margin-right: 10px;
      }
      .axisLabels {
        /* width: calc(100% - 140px); */
        width: calc(100% - 405px);
        border: #bbb 1px solid;
        height: 45px;
        display: inline-block;
        vertical-align: top;
        overflow: scroll;
        overflow: -moz-scrollbars-vertical;
      }
      .fieldType {
        margin-left: 0px;
        border: #ddd 1px solid;
        background: #f2f2f2;
      }
      #preprocessUI select option {
        background: #f2f2f2;
      }
      .selectAreaBtn {
        background: #eee;
        margin-left: 15px;
        margin-bottom: -2px;
      }

      #refChart {
        width: 500px;
        height: 400px;
        position: absolute;
        bottom: 0px;
        left: 10px;
        margin-left: 0px;
        border: #ccc 1px solid;
        background-color: white;
      }
      #preview {
        width: calc(98% - 300px);
        height: calc(98% - 450px);
        position: absolute;
        top: 0px;
        left: 300px;
        margin-left: 5px;
        margin-top: 35px;
        border: #ccc 0px solid;
      }

      .layerView {
        position: absolute;
        right: 0;
        top: 40px;
        width: 260px;
        height: 300px;
        /* background: #F7F7F7; */
        overflow: hidden;
        font-size: 12px;
      }

      .layerRow {
        fill: #f2f2f2;
        /* cursor: pointer; */
      }

      /* .layerRow:hover {
            fill: white;
        } */

      .layerSelected {
        fill: white;
      }

      .layerIcon {
        width: 15px;
        height: 15px;
        pointer-events: none;
      }

      .layerText {
        text-anchor: start;
        dominant-baseline: text-before-edge;
        alignment-baseline: text-before-edge;
        pointer-events: none;
      }
      #dialog {
        position: absolute;
        bottom: 300px;
        left: 520px;
        width: calc(100% - 520px);
        min-width: calc(100% - 522px);
        height: 100px;
        border-top: #ccc 1px solid;
        background-color: #fff;
        padding: 5px;
        padding-top: 10px;
        font-size: 18px;
        font-weight: bold;
      }
      span {
        display: inline-block;
        vertical-align: middle;
      }
      #saveButton {
        width: 100px;
        height: 30px;
        background: #eee;
        border: #ccc 1px solid;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        line-height: 10px;
      }
      #loadButton {
        position: absolute;
        bottom: 20px;
        right: 100px;
        width: 100px;
        height: 30px;
        background: #eee;
        border: #ccc 1px solid;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        line-height: 20px;
      }
      #alertBox {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s ease-in-out;
      }

      .textbox {
        width: 80%;
        height: 100%;
        box-sizing: border-box;
      }

      /* div.markDiv {
        display: "inline-block";
        width: "fit-content";
        height: "fit-content";
        border: "1px solid #000";
      } */
    </style>
  </head>
  <body ondrop="drop(event)" ondragover="allowDrop(event)">
    <div class="notification" id="alertBox">
      "notification info when saving"
    </div>
    <div style="display: none">
      <ul id="demoList" class="demos"></ul>
      <svg
        id="layers"
        style="
          position: absolute;
          top: 0px;
          left: 0px;
          width: 240px;
          height: 300px;
          background: #f2f2f2;
          border-right: 1px solid #ccc;
        "
      ></svg>
    </div>
    <div id="breadcrumb"></div>
    <button
      id="nextButton"
      onclick="nextSection()"
      style="position: absolute; left: calc(50% + 275px); top: 8px"
    >
      Next
    </button>
    <button
      id="prevButton"
      onclick="prevSection()"
      style="position: absolute; right: calc(50% + 260px); top: 8px"
    >
      Back
    </button>
    <div id="preprocessUI" style="visibility: visible">
      <div class="mainbox" id="axisAndLegend">
        <div style="margin-left: 20px">
          <span style="margin-right: 30px; font-weight: bold"
            >Axis & Legend Detection Results</span
          >
        </div>
        <div class="float-container" id="buttons" style="display: block">
          <!-- This is the main x axis div -->
          <div class="axisDiv" id="xAxisDiv">
            <!--This is the first part of the column-->
            <div class="axisMeta" id="xAxisMeta">
              <b>X axis</b>
              <input
                type="image"
                src="img/select-area.png"
                id="xArea"
                onclick="activateAreaSelect('x');"
                width="16px"
                height="16px"
                class="selectAreaBtn"
              /><br />
              <select
                class="fieldType"
                id="xFieldType"
                onchange="fieldTypeChanged('x')"
              >
                <option value="Null">none</option>
                <option value="string">categories</option>
                <option value="number">numbers</option>
                <option value="date">dates</option>
              </select>
            </div>

            <!--This is the second part of the column (title)-->

            <div
              class="axisTitle"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              id="xTitle"
            >
              <!--<div id="title-container">
                            <input type="text" class="textbox" placeholder="TITLE">
                          </div>-->
            </div>

            <!--This is the third part of the column (the label)-->
            <div
              class="axisLabels"
              id="xLabels"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
            ></div>
            <input
              type="image"
              src="img/plus.png"
              id="addXAxis"
              onclick="addAxisLevel('x');"
              width="16px"
              height="16px"
              style="position: absolute; right: 7px"
              class="selectAreaBtn"
            />
          </div>

          <!-- This is the main y axis div -->
          <div class="axisDiv" id="yAxisDiv">
            <!-- This is the 1st column div -->

            <div class="axisMeta">
              <b>Y axis</b
              ><input
                type="image"
                src="img/select-area.png"
                id="yArea"
                onclick="activateAreaSelect('y');"
                width="16px"
                height="16px"
                class="selectAreaBtn"
              /><br />
              <select
                class="fieldType"
                id="yFieldType"
                onchange="fieldTypeChanged('y')"
              >
                <option value="Null">none</option>
                <option value="string">categories</option>
                <option value="number">numbers</option>
                <option value="date">dates</option>
              </select>
            </div>

            <!-- This is the 2nd column div -->

            <div
              class="axisTitle"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              id="yTitle"
            ></div>

            <!-- This is the 3rd column div -->
            <div
              class="axisLabels"
              id="yLabels"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
            ></div>

            <input
              type="image"
              src="img/plus.png"
              id="addYAxis"
              onclick="addAxisLevel('y');"
              width="16px"
              height="16px"
              style="position: absolute; right: 7px"
              class="selectAreaBtn"
            />
          </div>

          <!-- This is the  main legend div -->

          <div class="axisDiv">
            <!-- This is the 1st column div -->

            <div class="axisMeta">
              <b>Legend</b
              ><input
                type="image"
                src="img/select-area.png"
                id="legendArea"
                onclick="activateAreaSelect('legend');"
                width="16px"
                height="16px"
                class="selectAreaBtn"
              /><br />
              <select class="fieldType" id="legendFieldType">
                <option value="Null">none</option>
                <option value="string">categories</option>
                <option value="number">numbers</option>
                <option value="date">dates</option>
              </select>
            </div>

            <!-- This is the 2nd column div-->
            <div
              class="axisTitle"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
              id="legendTitle"
            ></div>

            <!-- This is the 3rd column div-->
            <div
              class="axisLabels"
              id="legendLabels"
              ondrop="drop(event)"
              ondragover="allowDrop(event)"
            ></div>
          </div>
        </div>
        <button
          id="saveButton"
          onclick="post()"
          style="position: absolute; bottom: 5px; right: 5px"
        >
          Save
        </button>
      </div>
      <div id="container">
        <div
          id="rbox1"
          class="rbox1"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            display: block;
            border: #ccc 0px solid;
          "
        ></div>
        <div
          id="rbox2"
          class="rbox2"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            display: block;
            pointer-events: none;
            border: #ccc 0px solid;
          "
        >
          <svg
            id="overlay"
            height="100%"
            width="100%"
            preserveAspectRatio="xMinYMid"
          >
            <rect
              id="overlaySelection"
              style="
                visibility: hidden;
                stroke-width: 2px;
                stroke: blue;
                fill: none;
              "
            ></rect>
          </svg>
        </div>
        <div
          id="generalizedSelection"
          style="
            position: absolute;
            top: 20%;
            right: 10px;
            display: block;
            width: 40%;
            height: 75%;
            border: #ccc 0px solid;
          "
        >
          <div style="height: 100%">
            <h3>All Mark IDs</h3>

            <div
              id="allMarks"
              style="
                height: 90%;
                width: 250px;
                border: #0ba7bc 1px solid;
                padding: 5px;
                margin-bottom: 10px;
                vertical-align: top;
                overflow: scroll;
                overflow: -moz-scrollbars-vertical;
              "
            ></div>
          </div>
          <div
            style="
              height: 100%;
              width: calc(100% - 275px);
              position: absolute;
              top: 0;
              right: 0;
            "
          >
            <h3>Mark Selections</h3>
            <div
              id="markSelections"
              style="
                height: calc(90% - 150px);
                width: 100%;
                border: #0ba7bc 1px solid;
                padding: 5px;
                margin-bottom: 10px;
                vertical-align: top;
                overflow: scroll;
                overflow: -moz-scrollbars-vertical;
              "
            ></div>
          </div>
          <div
            style="
              height: 150;
              width: calc(100% - 275px);
              position: absolute;
              bottom: 0;
              right: 0;
            "
          >
            <h3>Mark Types and Roles</h3>
            <div
              id="markRoles"
              style="
                height: 100%;
                width: 100%;
                border: #0ba7bc 1px solid;
                padding: 5px;
                margin-bottom: 10px;
              "
            >
              <div width="100%">
                Select a Mark Type
                <select
                  class="fieldType"
                  id="markTypeSelection"
                  onchange="markAnnotationChanged('Type')"
                >
                  <option value="none">none</option>
                  <option value="Rectangle">Rectangle</option>
                  <option value="Circle">Circle</option>
                  <option value="Area">Area</option>
                  <option value="Singleline">Single line</option>
                  <option value="Polyline">Polyline</option>
                </select>
              </div>
              <br />
              <div width="100%">
                Select a Mark Role
                <select
                  class="fieldType"
                  id="markRoleSelection"
                  onchange="markAnnotationChanged('Role')"
                >
                  <option value="none">none</option>
                  <option value="Main Chart">Main Chart</option>
                  <option value="Annotation">Annotation</option>
                  <option value="Gridlines">Gridlines</option>
                  <option value="Noise">Noise</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.addEventListener("beforeunload", function (event) {
        event.returnValue = "Are you sure you want to leave?";
        return "Are you sure you want to leave?";
      });

      // breadcrumb ui functions
      const sectionTitles = [
        "Axis & Legend",
        "Marks",
        "Groups",
        "Layout",
        "Encodings",
        "Constraints",
      ];

      let currentSectionIndex = 0;

      function nextSection() {
        if (currentSectionIndex < sectionTitles.length - 1) {
          currentSectionIndex++;
        }
        updateBreadcrumb();
      }

      function prevSection() {
        if (currentSectionIndex > 0) {
          currentSectionIndex--;
        }
        updateBreadcrumb();
      }

      // Function to update the breadcrumb navigation
      function updateBreadcrumb() {
        const breadcrumbContainer = document.getElementById("breadcrumb");
        breadcrumbContainer.innerHTML = ""; // Clear previous breadcrumbs

        for (let i = 0; i < sectionTitles.length; i++) {
          const breadcrumbItem = document.createElement("span");
          breadcrumbItem.textContent = sectionTitles[i];
          breadcrumbItem.classList.add("breadcrumb-item");
          if (i === currentSectionIndex) {
            breadcrumbItem.classList.add("current-section");
          }
          breadcrumbContainer.appendChild(breadcrumbItem);

          if (i < sectionTitles.length - 1) {
            const separator = document.createElement("span");
            separator.textContent = " | ";
            breadcrumbContainer.appendChild(separator);
          }
        }
        arrangeAnnotationDivs(sectionTitles[currentSectionIndex]);
      }

      function arrangeAnnotationDivs(currentStage) {
        switch (currentStage) {
          case "Axis & Legend":
            console.log("stage 1!");
            referenceElements.forEach((rid) => {
              d3.select("#" + rid).style("opacity", "1");
            });
            document.getElementById("axisAndLegend").style.visibility =
              "visible";
            document.getElementById("generalizedSelection").style.visibility =
              "hidden";
            break;
          case "Marks":
            console.log("stage 2!");

            // remove all reference elements from mainContent
            mainContent = groupSVGElementsByType();
            console.log(mainContent);

            // below for initilizing the mark annotation
            initilizeMarkAnnotation();

            document.getElementById("axisAndLegend").style.visibility =
              "hidden";
            document.getElementById("generalizedSelection").style.visibility =
              "visible";
            break;
          default:
            document.getElementById("axisAndLegend").style.visibility =
              "hidden";
            document.getElementById("generalizedSelection").style.visibility =
              "hidden";
            break;
        }
      }

      // Initialize the section title and breadcrumb navigation
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize breadcrumb navigation
        updateBreadcrumb();
      });

      window.onhashchange = refresh;
      let uploaded = false;
      let metaData;
      var demoName, mainContent;
      var areaSelection;
      var numOfColor;
      var atlasSceneGraph,
        atlasRenderer = atlas.renderer("svg", "atlasCanvas"),
        atlasTbl;
      let chartName2Path = null;
      let chartUrl2Web = null;

      function refresh() {}
      // getting file name from url
      const urlParams = new URLSearchParams(window.location.search);
      const fileName = urlParams.get("file");

      console.log(fileName);

      if (fileName) {
        // load file from url if it exists
        sessionStorage.setItem("fileName", fileName + ".svg");
        loadDemo(fileName);
      } else if (
        sessionStorage.getItem("svg") &&
        sessionStorage.getItem("svg").length > 0
      ) {
        loadDemo("artboard");

        let demo = window.location.hash.replace("#", "");

        if (demo && demo != "") {
          d3.select("body").style("overflow-y", "hidden");
          window.scrollTo(0, 0);
          loadDemo(demo);
        } else {
          d3.select("body").style("overflow-y", "auto");
        }
      }

      function loadDemo(demo) {
        loadFile();
        fetch("./examples/" + demo + ".svg")
          .then((resp) => {
            return resp.text();
          })
          .then((rawSVG) => {
            if (
              sessionStorage.getItem("svg")
                ? sessionStorage.getItem("svg").length > 0
                : false
            )
              rawSVG = sessionStorage.getItem("svg");
            undoStack = [];
            redoStack = [];
            atlasSG_histroy = [];
            steps = [];
            chartDecomposition = {};
            btnCheck = {};

            titleXaxis = [];
            inXTitle = false;
            titleYaxis = [];
            inYTitle = false;
            titleLegend = [];

            legend = {};
            xAxis = {};
            yAxis = {};
            xGridlines = {};
            yGridlines = {};
            demoName = demo;
            d3.select("#preprocessUI").style("visibility", "visible");
            d3.select("#layers").selectAll("*").remove();
            d3.selectAll(".axisLabels").selectAll("button").remove();

            // in display.js, adding id and class attributes to the svg elements
            displaySVG(rawSVG);

            // TBD: we need to update the flattenSVG function to be consistent with groupSVGElementsByType(), to avoid the previous complex lead-node processing
            let jsonArr = flattenSVG(rawSVG);
            // in preprocess-interaction.js, attaching drag and drop event listeners to the svg text elements
            enableDragDrop(jsonArr.texts);

            // in extract.js, extracting from the svg file the legend mark and labels, and the x and y axis labels, ticks, and paths if any, and the grid lines if any
            // extract() calls displayAxis() and displayLegend() to display the extracted elements
            extract(jsonArr);

            // in display.js, setting a proper view box for the svg file so that the svg file fits into the browser window
            setViewBox();

            // in preprocess-interaction.js, activating the area-selecting event so that one can also select the area of the legend, or x and y axis to annotate
            enableAreaSelection();
          });
      }

      function post() {
        let xhr = new XMLHttpRequest();
        xhr.open("POST", "/");
        xhr.overrideMimeType("text/plain");
        xhr.setRequestHeader("Accept", "application/json");
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              const alertBox = document.getElementById("alertBox");
              alertBox.textContent = `Annotations for the chart has been saved successfully to 'annotations / ${sessionStorage.getItem(
                "fileName"
              )}.json'!`;
              alertBox.style.visibility = "visible";
              alertBox.style.opacity = "1";

              // Hide the alert box after 3 seconds
              setTimeout(function () {
                alertBox.style.visibility = "hidden";
                alertBox.style.opacity = "0";
              }, 3000);
              console.log(xhr.responseText);
            } else {
              console.error("Error: " + xhr.status);
              alertBox.textContent =
                "Error: '" +
                xhr.status +
                "' occurred while saving the annotations";
              alertBox.style.visibility = "visible";
              alertBox.style.opacity = "1";
            }
          }
        };
        let data = {};
        data["chart"] = sessionStorage.getItem("fileName");
        data["annotation"] = annotations;
        console.log(data["chart"]);
        xhr.send(JSON.stringify(data));
      }

      function getKeyByValue(object, value) {
        return Object.keys(object).find((key) => object[key] === value);
      }

      document.addEventListener("keyup", function (e) {
        if (e.code == "Escape") deactivateAreaSelect();
      });

      $(document).ready(() => {
        refresh();
      });
    </script>
  </body>
</html>
